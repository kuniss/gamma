name: Release
on: 
  release:
    types: [published]

jobs:

  verify:
    uses: ./.github/workflows/test.yml
    with:
      dmd_compiler_version: dmd-2.103.1

  build:
    uses: ./.github/workflows/build.yml
    with:
      lcd_compiler_version: ldc-1.33.0
    needs: verify

  release-upload:
    name: Upload release binaries
    needs: build
    strategy:
      matrix:
        os: [windows, linux, macos]
        include:
          - os: windows
            exe-name: gamma.windows-amd64.exe
            rename: mv ./gamma.exe
          - os: linux
            exe-name: gamma.linux-amd64
            rename: mv ./gamma
          - os: macos
            exe-name: gamma.macos-amd64
            rename: mv ./gamma

    runs-on: ubuntu-latest
    steps:
      - name: Download binary from previous build job
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.exe-name }}

      - name: Give binary a unique name 
        run:  ${{ matrix.rename }} ${{ matrix.exe-name }}
      
      - name: Upload release binary
        uses: AButler/upload-release-assets@v3.0
        with:
          files: ${{ matrix.exe-name }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
